# stpLib: работа с базой данных

## Низкоуровневое
Лежит в пространстве имён `stp.db.low`.

- Структура `.Database` - собственно, база данных
    - Можно сделать такую, в которой все таблицы - временные
    - Можно держать несколько БД одновременно открытыми (например, для обновления данных со старой БД)

- Типаж для таблицы (`.Table`), он же - менеджер строк
    - Как аргумент конструктора принимает `.Database`
    - Можно явно сделать временной
- Типаж для строки (`.Row`)
    - Может содержать в себе переменные, соответсвующие столбцам БД (`.Column`)
        - Имеют схему (`trait .ColumnSchema`)
            - Конвертирует данные в строку SQL-запроса
            - Конвертирует данные из результата SQL-запроса


Что нужно поддерживать:
- Inlining колонок, содержащих составные объекты
    - Например, `a: Vector` -> `a__x: number, a__y: number, a__z: number`
- Генерацию SQL-запросов с валидацией (в init-time) - в низкоуровневую библиотеку ли?
- Объединение запросов в транзакции
- Сохранение схемы данных (или хотя-бы версий таблиц) в базе данных - для того, чтобы можно было обновлять структуру данных
    - Соответсвтенно, миграции при обновлении


## Высокоуровневое
Обобщает работу с SQLite, с данными дубликатора.
Лежит в пространстве имён `stp.db`

Данные - как в низкоуровневом API (`.Database`, `.Table`, `.Row`, `.Column`, `.ColumnSchema`).
Запросы - не ясно, как: либо через DSL, либо SQL-с-расширениями (как тогда для не-SQLite-хранилищ?).

### Необходимый функционал

- Перенос данных между хранилищами (в т.ч. без создания (полноценных?) объектов колонок)
    - Нужно для дубликатора - из данных дубликатора создаётся временное хранилище, 
    его содержимое добавляется к основному хранилищу
    - Какие-нибудь временные данные, например предметы, которые ещё рано сохранять в базу данных 
    (может, игрок их вообще удалит через минуту?)
- Функционал таблиц:
    - Внешние ключи
    - Индексация по первичному ключу
    - `CHECK`, `DEFAULT`, `NOT NULL` для ключей, `CHECK` для таблицы
    - `UNIQUE`
- Таблицы в памяти
    - Доступ к колонке таблицы и соотв. колоке таблицы-расширения через один объект (?)
- Функционал запросов:
    - Поддержка индексов
    - `SELECT`
        - `WHERE`
        - `JOIN`
        - `UNION` и т.п.
        - ? вложенные запросы
        - ? рекурсивные запросы
    - `INSERT`, `UPDATE`, `REMOVE`
    - Поддержка группировки в транзакции