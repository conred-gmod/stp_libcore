# stp.db - ORM-система

## Схема данных
Все пользовательские объекты, помещаемые в ORM-систему, должны иметь при себе схему данных.

Схему данных можно создать для типажа или конечного типа.
Если типаж со схемой наследуется, то у наследника тоже должна быть схема.
У объекта может быть несколько родителей со схемой.

Задаваемые данные схемы:
- Уникальное название (обычно, название типа)
- ? Ссылку на тип
- Является ли тип типажом или нет?
- Список названий родительских схем
- Описания колонок/полей
    - Название
    - Тип (может быть составным типом, ? может быть типом-суммой, может допускать nil {частный случай типа-суммы с nil})
    - Опциально, значение по-умолчанию
- Описание ограничений {для разных типов ограничений формат разный}
    - Тип - PrimaryKey
        - Список названий колонок
    - Тип - Unique
        - Список названий колонок
        - Опциально, предикат активации ограничения, зависящий от строчки, описываемой этой схемой
    - Тип - Check
        - Предикат, зависящий от строчки, описываемой этой схемой
    - Тип - ForeignKey
        - Список названий местных колонок
        - Название схемы, содержащей внешние колонки
        - Список названий внешних колонок

Внутренние данные схемы:
- ID каждой колонки
- ? Данные для работы с внешней базой данных

Конечной схемой называется схема конечного типа.
Соответственно, схема-типаж - схема типажа.

## Индексы
Каждой схеме можно добавить произвольное количество индексов.

Индекс должен содержать список индексируемых колонок.
Индекс может содержать предикат ограничения, зависящий от строчки, описываемой схемой.
Индекс должен содержать флаг использования в Lua-хранилищах и во внешних хранилищах.

Индекс может быть уникальным - тогда нельзя добавить в таблицу, описываемую схемой, несколько строк, соотв. текущему индексу.
Под капотом некоторые первичные ключи и ограничения уникальности реализуются как особый вид индексов.
Уникальный индекс всегда используется везде, делать его неиспользуемым нельзя.

## Хранение в Lua-таблицах
Один из способов хранения данных - в Lua-таблицах.

### Данные для каждой конечной схемы
В БД хранятся все строки (lua-таблица по внутреннему ключу).

Строка содержит:
- Значения каждого поля (lua-ключ - ? целое число)
- Битовую маску сырых полей (по ExtDB-индексу), если lua-хранилище отражает другое хранилище.

#### Внутренний ключ
Если схема имеет единственный "удобный" первичный ключ, то он является внутренним ключом.
Если схема имеет несколько "удобных" первичных ключей, произвольно выбирается одна из колонок и используется как внутренний ключ. (Одна и та же колонка для всех строк в схеме)

Удобны те ПК, которые имеют числовой, строковый или булев тип.

Если "удобных" первичных ключей нет, внутренний ключ - монотонно возрастающее неотрицательное целое число.
Тогда следующий внутренний ключ хранится в данных конечной схемы.  

### Данные для каждого индекса

Значение хеш-таблицы - если индекс на конечной схеме, то внутр. ключ, иначе (идент. схемы, внутр. ключ).

Если индексируемая колонка всего одна и имеет числовой, строковый или булев тип, индекс хранит данные в виде lua-таблицы
с ключом, равним инд. колонке.

Иначе, используется собственная реализация хеш-таблицы с ключом из индексируемых колонок. 

