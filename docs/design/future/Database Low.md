# stpLib.db - низкоуровневая работа с базами данных


С точки зрения дизайна lua-таблицы первостепенны.

## Первичный ключ колонки
Если в колонке первичный ключ имеет не-ссылочный lua-тип (`string`/`number`/`bool`), 
то внутренним ключом является первичный ключ.

Если же тип ссылочный (`table`, `userdata`), то в колонке хранится каноничный экземпляр внутреннего ключа
(каноничный экземпляр таблицы или юзердаты).


## Объекты

```
namespace stp.db;

internal struct ._MemoryDatabase {
    internal var ._Tables: table(typeid: string, 
        table(value._InternalKey, value: ._Column))
}

internal trait ._Column {
    abstract type .PrimaryKeyType

    internal var ._InternalKey: .PrimaryKeyType

    
}



// Пример
struct .ExampleColumnImpl {
    require ._Column

    var .SteamID: string
    impl type .PrimaryKeyType = string

    <oninit: ._InternalKey = .SteamID>

    var .TotalTime: number
    var .LastJoinTime: number
}

```


! Поток потоков колонок неявно преобразуется в поток колонок:
- Если над ст

## Данные колонок

### Простые данные (или inlined data)
В памяти: хранить как поля.

В иерархическом формате: хранить как поля.

В реляционном формате:
- Если примитивной тип, хранить как столбцы
- Если составной тип, все составные элементы хранить как столбцы (распрастранить ограничения)

### Foreign Key to Primary Key
В памяти: в обеих таблицах хранить массив или одну ссылку на другую таблицу.

В иерархическом и реляционном формате: хранить сводную таблицу (пары первичных ключей)

## Операции

### Insert
Аргументы - таблица, поток данных.

1. Проверяет данные из аргументов на корректность
2. Создаёт объекты колонок из данных
3. Вставляет колонки в таблицы
4. Разрешает ограничения связанных таблиц
5. Опциально, возвращает поток созданных колонок

### Update
???

### Delete
Аргумент - таблица, поток колонок из этой таблицы.

1. Удаляет колонки из таблицы
2. Разрешает ограничения связанных таблиц
3. Опциально, возвращает поток удалённых колонок

### Filter
Аргумент - поток колонок, выражение-фильтр

Возращает поток колонок, содержащий только те колонки, которые удовлетворяют фильтру.

### OrderBy
Аргумент - поток колонок, выражение-хеш-функция

Возвращает поток колонок, отсортированынй по значению хеш-функции от колонки

### Limit
Аргумент - поток колонок, выражение

Возвращает поток колонок, содержащий только то количество колонок, чему равно выражение()

### Offset
Аргумент - поток колонок, выражение

Возвращает поток колонок, пропуская столько колонок, чему равно выражение()

### Join

Аргумент - 
    два потока колонок, 
    выражение-фильтр, 
    флаги создания null-колонок в противоположном потоке при условии отсуствия удовл. фильтру колонок в этом потоке.

1. Для каждой левой колонки и правой колонки (тензорно):
    1. Проверить фильтр 
        - `true`, вернуть пару из левой и правой колонки
        - Если для данной левой колонки и всех правых колонок возвращает false и стоит флаг создания правой null-колонки, вернуть пару из левой колонки и правой null-колонки
        - То же для правой колонки и всех левых

### Constant
Аргумент - массив данных

Возвращает поток колонок, сделанный из этого массива

### Combine, Union, Intersect, Except
Аргумент - два потока колонок (одинаковой сигнатуры)

1. Сохранить левый поток в массив
2. Выполнить операцию над правыми колонками и массивом (для Combine и Union - добавлять элементы, для Except - удалять, для Intersect помечать флагом элементы, удалять те, что без флага)
3. Вернуть массив как поток колонок

### Select
Аргумент - поток колонок, сигнатура результата и набор выражений для кажого поля результата

Для каждой колонки вернуть новую колонку с заданной сигнатурой и значениями, определёнными выражениями над данными этой колонки

### GroupBy
Аргумент - поток колонок, выражение-хеш-функция

Группирует в поток потоков колонок, где у каждого вложенного потока одинаковое значение хеш-функции для всех колонок.
